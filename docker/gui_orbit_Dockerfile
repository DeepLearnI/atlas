# Copyright (C) DeepLearning Financial Technologies Inc. - All Rights Reserved
# Unauthorized copying, distribution, reproduction, publication, use of this file, via any medium is strictly prohibited
# Proprietary and confidential
# Written by Susan Davis <s.davis@dessa.com>, 10 2019

FROM node:10.16-alpine

RUN apk add --update gettext libintl nginx openssl && \
    mkdir /run/nginx/ && \
    nginx && \ 
    openssl req -x509 -nodes -days 365 \
                -subj "/C=CA/ST=Ontario/L=Toronto/O=Dessa/OU=Engineering/CN=localhost" \
                -newkey rsa:2048 \
                -keyout /etc/nginx/localhost.key \
                -out /etc/nginx/localhost.crt

COPY --from=loicmahieu/alpine-envsubst /usr/local/bin/envsubst /usr/local/bin/envsubst

RUN mkdir -p /var/foundations_ui
WORKDIR /var/foundations_ui

ENV REACT_APP_API_URL=/foundations_rest_api/api/v1/
ENV REACT_APP_API_STAGING_URL=/foundations_rest_api/api/v2beta/
ENV REACT_APP_APIARY_URL=http://private-d03986-iannelladessa.apiary-mock.com/
ENV REACT_APP_SCHEDULER_TYPE=ORBIT-TEAM
ENV SERVER_NAME=localhost
ENV NODE_OPTIONS=--max_old_space_size=8192

COPY ./ /var/foundations_ui_orbit/

RUN npm install -g -s --no-progress yarn && \
    yarn && \
    yarn run build && \
    yarn run prune && \
    yarn cache clean

EXPOSE 8011
COPY deploy/nginx.conf /etc/nginx/nginx.conf.template
CMD ["/bin/bash", "/var/foundations_ui_orbit/deploy/run_ui.sh"]

