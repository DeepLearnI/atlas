# Copyright (C) DeepLearning Financial Technologies Inc. - All Rights Reserved
# Unauthorized copying, distribution, reproduction, publication, use of this file, via any medium is strictly prohibited
# Proprietary and confidential
# Written by Thomas Rogers <t.rogers@dessa.com>, 06 2018

FROM tiangolo/uwsgi-nginx-flask:python3.6-alpine3.8

ARG main_file

ENV SERVER_NAME=localhost
ENV AUTH_SERVER_URL=http://foundations-authentication-server:8080/auth
ENV AUTH_CLIENT_CONFIG_PATH=/configs/auth_client_config.yaml

RUN mkdir -p /var/foundations ~/.ssh
WORKDIR /var/foundations

RUN apk add --update --no-cache alpine-sdk python-dev libressl-dev libffi-dev linux-headers
RUN pip install -U pip setuptools wheel
COPY ./tmp/pip_wheels /var/foundations/

RUN find -iname "foundations_internal-*.whl" | xargs pip install \
    && find -iname "foundations_events-*.whl" | xargs pip install \
    && find -iname "foundations_contrib-*.whl" | xargs pip install \
    && find -iname "foundations_local_docker_scheduler_plugin-*.whl" | xargs pip install \
    && find -iname "foundations_core_rest_api_components-*.whl" | xargs pip install \
    && find -iname "foundations_rest_api-*.whl" | xargs pip install \
    && echo "Completed foundations package installation"

WORKDIR /app/
COPY docker/${main_file} /app/main.py

RUN mkdir /configs
COPY foundations_rest_api/src/foundations_rest_api/config/ /configs/
