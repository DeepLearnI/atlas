# Copyright (C) DeepLearning Financial Technologies Inc. - All Rights Reserved
# Unauthorized copying, distribution, reproduction, publication, use of this file, via any medium is strictly prohibited
# Proprietary and confidential
# Written by Thomas Rogers <t.rogers@dessa.com>, 06 2018

FROM tiangolo/uwsgi-nginx-flask:python3.6

ARG main_file

RUN python -m pip install --upgrade pip==19.3 && \
        python -m pip install setuptools wheel && \
    curl -LO https://storage.googleapis.com/kubernetes-release/release/v1.10.3/bin/linux/amd64/kubectl && \
        chmod +x kubectl && \
        mv kubectl /usr/bin/ && \
    mkdir -p /var/foundations ~/.ssh

ENV SERVER_NAME=localhost

COPY ./tmp/pip_wheels /var/foundations/
WORKDIR /var/foundations

RUN find -iname "foundations_scheduler_deployment*.whl" | xargs pip install
RUN find -iname "foundations_scheduler_core*.whl" | xargs pip install
RUN find -iname "foundations_scheduler*.whl" | xargs pip install
RUN find -iname "*.whl" | xargs pip install

WORKDIR /app/
COPY docker/${main_file} /app/main.py
